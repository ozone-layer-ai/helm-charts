{{- if .Values.httproute.enabled -}}
{{- $fullName := include "microservice.fullname" . -}}
{{- $svcPort := .Values.service.port -}}

apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: {{ $fullName }}
  labels:
    {{- include "microservice.labels" . | nindent 4 }}
  {{- with .Values.httproute.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}

spec:
  parentRefs:
    - name: {{ .Values.httproute.gateway.name }}
      namespace: {{ .Values.httproute.gateway.namespace | default .Release.Namespace }}
      {{- if .Values.httproute.gateway.sectionName }}
      sectionName: {{ .Values.httproute.gateway.sectionName }}
      {{- end }}

  {{- if .Values.httproute.hostnames }}
  hostnames:
    {{- range .Values.httproute.hostnames }}
    - {{ . | quote }}
    {{- end }}
  {{- end }}

  rules:
    {{- range .Values.httproute.rules }}
    - matches:
        {{- range .matches }}
        - path:
            type: {{ .path.type | default "PathPrefix" }}
            value: {{ .path.value | quote }}
        {{- end }}

      {{- $filters := list }}

      {{- if $.Values.httproute.middlewares.stripPath.enabled }}
      {{- $filters = append $filters (dict
          "type" "URLRewrite"
          "urlRewrite" (dict
            "path" (dict
              "type" "ReplacePrefixMatch"
              "replacePrefixMatch" "/"
            )
          )
        )
      }}
      {{- end }}

      {{- if include "microservice.hasChainedMiddlewares" $ }}
      {{- $filters = append $filters (dict
          "type" "ExtensionRef"
          "extensionRef" (dict
            "group" "traefik.io"
            "kind" "Middleware"
            "name" (printf "%s-chain" $fullName)
          )
        )
      }}
      {{- end }}

      {{- if gt (len $filters) 0 }}
      filters:
        {{- toYaml $filters | nindent 8 }}
      {{- end }}

      backendRefs:
        - name: {{ $fullName }}
          port: {{ $svcPort }}
    {{- end }}

{{- end }}
